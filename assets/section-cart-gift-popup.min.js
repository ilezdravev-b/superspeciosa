!function(t){"function"==typeof define&&define.amd?define("cartGiftPopup",t):t()}((function(){"use strict";const t=".js-free-gift-button",e=".js-hide-free-gift-modal",n=".js-hide-free-gift-modal-no-selection";async function i(t,e,n){if("/cart"===window.location.pathname)return void o(t,e);localStorage.setItem("CART_CHANGED",t),localStorage.setItem("CART_REMOVED",t);const i=await fetch("/cart.js"),a=await i.json();let c={updates:{}};const d=a.items.find((e=>e.key==t)),r=a.items.filter((t=>{if(t.properties.t&&t.properties.t==d.properties.t)return t}));r.length>0?r.forEach((t=>{c.updates[t.key]=e})):c.updates[t]=e,await window.updateCartViaUpdateApi(c),nvd_init().then((()=>{updateLiveCart().then((()=>{})).then((()=>{fetch("/cart.js").then((t=>t.json())).then((t=>window.updateMiniCart()))}))}))}window.onclickUpdateQuantity=function(t){document.querySelector(".cart-spinner").style.display="flex",document.querySelector(".cart-spinner .Message").textContent="Updating the cart",i(t.dataset.lineId,t.dataset.quantity,t.dataset.isFreeGift)},window.onchangeUpdateQuantity=function(t){i(t.dataset.lineId,t.value,t.dataset.isFreeGift),document.querySelector(".cart-spinner").style.display="flex",document.querySelector(".cart-spinner .Message").textContent="Updating the cart"},window.onclickRemoveItem=function(t){document.querySelector(".cart-spinner").style.display="flex",document.querySelector(".cart-spinner .Message").textContent="Removing the item",i(t.dataset.lineId,"0",t.dataset.isFreeGift)},window.updateMiniCart=async function(){console.log("update mini cart!"),fetch(window.fmData.theme.localeRootUrl+"/cart?view=ajax&timestamp="+Date.now(),{credentials:"same-origin",method:"GET"}).then((function(t){t.text().then((function(t){})),"/cart"===window.location.pathname&&window.buildOptionsPricesList(),console.log("dislay free gfit popup?"),d()}))},window.updateCartViaUpdateApi=async t=>{await fetch(window.fmData.theme.localeRootUrl+"/cart/update.js",{body:JSON.stringify(t),credentials:"same-origin",method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"}})},window.checkAndRemoveIneligibleFreeItem=async()=>{const t=await fetch("/cart.js"),e=await t.json(),n=e.items.find((t=>t.properties?.i));if(n){const t={updates:{}},{total_price:i}=e,o=i-n.price,{properties:{o:a,p:c}}=n;(o<a||o>c)&&(t.updates[n.id]=0,await window.updateCartViaUpdateApi(t))}},window.showFreeGiftModal=function(){const t=document.querySelector(".modal"),e=document.querySelector(".overlay");t&&e&&(t.classList.remove("hidden"),e.classList.remove("hidden"))},window.findAndRemoveFreeItem=()=>{showFreeGiftModal()},window.hideFreeGiftModal=function(t){t&&"/cart"!==window.location&&localStorage.setItem("freeGiftDeniedByCustomer",!0);const e=document.querySelector(".modal"),n=document.querySelector(".overlay");e&&n&&(e.classList.add("hidden"),n.classList.add("hidden"))};const o=(t,e,n)=>{const i={id:t,quantity:e};localStorage.setItem("CART_CHANGED",t),localStorage.setItem("CART_REMOVED",t),fetch("/cart/change.js",{body:JSON.stringify(i),credentials:"same-origin",headers:{"Content-Type":"application/json","X-Requested-With":"xmlhttprequest"},method:"POST"}).then((t=>t.json())).then((t=>{const{total_price:e,items:n}=t;a({totalPrice:e,items:n}),window.location=window.location.href})).catch((t=>{console.error(t)}))},a=({totalPrice:t,items:e})=>{const n=e.find((t=>t.properties?.i));if(n){const e=t-n.price,{properties:{o:i,p:o}}=n;if(e<i||e>o)return void c(n)}},c=async({key:t,properties:e})=>{const{u:n}=e,i={price_rule_id:n,operation:"DELETE"};fetch("https://triple-tier-gift-rpzwsjix5q-uc.a.run.app",{body:JSON.stringify(i),headers:{"Content-Type":"application/json"},method:"POST"}),await fetch("/cart/change.js",{body:JSON.stringify({id:t,quantity:0}),credentials:"same-origin",headers:{"Content-Type":"application/json","X-Requested-With":"xmlhttprequest"},method:"POST"}),window.location=window.location.href},d=()=>{"true"!==localStorage.getItem("freeGiftDeniedByCustomer")&&(fetch(window.location.pathname+"?sections=cart-gift-popup").then((t=>t.json())).then((t=>{const e=t["cart-gift-popup"];document.createElement("div").innerHTML=e,console.log("displayFreeGiftPopUp > cart-gift-popup html content?",e)})),showFreeGiftModal())};document.querySelector(t)&&document.querySelector(t).addEventListener("click",findAndRemoveFreeItem()),document.querySelector(e)&&document.querySelector(e).addEventListener("click",hideFreeGiftModal()),document.querySelector(n)&&document.querySelector(n).addEventListener("click",hideFreeGiftModal(!0)),window.EventBus.on("cart:updated",updateMiniCart)}));